<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proyección por Series de Tiempo - Métodos Estadísticos FIT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="top-bar">
    <div>
      <a href="https://fit.um.edu.mx" target="_blank">🌐 https://fit.um.edu.mx</a>
    </div>
    <div>
      <a href="#"><i class="fab fa-facebook-f"></i></a>
      <a href="#"><i class="fab fa-twitter"></i></a>
      <button class="btn-theme" onclick="toggleTheme()">🎨 Tema</button>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="https://fit.um.edu.mx/wp-content/uploads/2021/11/color-fitec-nombre.png" alt="FIT">
      </a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="registrar.html">Registrar Año</a></li>
          <li class="nav-item"><a class="nav-link" href="historico.html">Ver Histórico</a></li>
          <li class="nav-item"><a class="nav-link" href="proyeccion.html">Proyección General</a></li>
          <li class="nav-item"><a class="nav-link active" href="grafica.html">Series de Tiempo</a></li>
          <li class="nav-item"><a class="nav-link" href="acerca.html">Acerca de</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="banner">
    <div class="container">
      <div class="hashtag">#SOYFITEC</div>
      <h1>FACULTAD DE INGENIERÍA Y TECNOLOGÍA</h1>
      <div class="hashtag">#Fitec30</div>
    </div>
  </div>

    <main class="container-main">
        <div class="content-area">
            <h4 class="mb-4">Modelo de Predicción por Series de Tiempo</h4>
            
            <div class="row g-3 align-items-end mb-4">
                <!-- Selección de Datos -->
                <div class="col-md-4">
                    <label for="data-series" class="form-label">Variable a Analizar</label>
                    <select id="data-series" class="form-select">
                        <option value="TOTAL_INGRESOS">Total de Ingresos</option>
                        <option value="TOTAL_EGRESOS">Total de Egresos</option>
                    </select>
                </div>

                <!-- Parámetros del Modelo -->
                <div class="col-md-4">
                    <label for="alpha-value" class="form-label">Constante de Suavizamiento (α)</label>
                    <input type="number" id="alpha-value" value="0.3" min="0.1" max="0.9" step="0.1" class="form-control">
                </div>

                <!-- Botón de Acción -->
                <div class="col-md-4">
                    <button id="calculate-btn" class="btn btn-main-action w-100">Calcular y Graficar Proyección</button>
                </div>
            </div>
        </div>

        <div class="content-area mt-4" id="results-container" style="display: none;">
            <h4 class="mb-4">Resultados de la Proyección</h4>
            <div class="chart-container">
                <canvas id="projection-chart"></canvas>
            </div>
            <div class="mt-8">
                 <h5 class="mb-3">Tabla de Datos y Pronósticos</h5>
                 <div id="results-table" class="overflow-x-auto"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>© <span id="currentYear"></span> Facultad de Ingeniería - Métodos Estadísticos</p>
        </div>
    </footer>

    <script src="main.js"></script>
    <script>
        // Referencia a los elementos del DOM
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsContainer = document.getElementById('results-container');
        const chartCanvas = document.getElementById('projection-chart');
        const resultsTable = document.getElementById('results-table');
        const alphaInput = document.getElementById('alpha-value');
        
        let myChart;
        let historicalData = {};

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', async () => {
          try {
            const response = await fetch('http://localhost:3000/api/registros');
            if (!response.ok) throw new Error(`Error ${response.status}`);
            const data = await response.json();

            if (!Array.isArray(data) || data.length === 0) {
              alert('No hay datos suficientes para el análisis.');
              return;
            }

            // Agrupar por año
            const dataByYear = data.reduce((acc, curr) => {
                const year = curr.Año;
                if (!acc[year]) {
                    acc[year] = { TOTAL_INGRESOS: 0, TOTAL_EGRESOS: 0 };
                }
                acc[year].TOTAL_INGRESOS += curr.Ingresos || 0;
                acc[year].TOTAL_EGRESOS += curr.Egresos || 0;
                return acc;
            }, {});

            const sortedYears = Object.keys(dataByYear).sort((a, b) => a - b);

            historicalData = {
                labels: sortedYears,
                TOTAL_INGRESOS: sortedYears.map(year => dataByYear[year].TOTAL_INGRESOS),
                TOTAL_EGRESOS: sortedYears.map(year => dataByYear[year].TOTAL_EGRESOS)
            };

          } catch (error) {
            console.error('Error al cargar datos:', error);
            alert(`Error al cargar datos: ${error.message}`);
          }
        });

        // --- FUNCIONES DE CÁLCULO DE SERIES DE TIEMPO ---

        /**
         * Calcula el Promedio Móvil Simple (SMA).
         */
        function calculateSMA(data, period) {
            const sma = Array(period).fill(null); // No hay pronóstico para los primeros 'period' datos
            for (let i = period; i < data.length; i++) {
                const chunk = data.slice(i - period, i);
                const sum = chunk.reduce((a, b) => a + b, 0);
                sma.push(Math.round(sum / period));
            }
            // Pronóstico para el siguiente periodo
            const lastChunk = data.slice(-period);
            const forecast = Math.round(lastChunk.reduce((a,b) => a+b, 0) / period);
            sma.push(forecast); // Añade el pronóstico para el siguiente periodo
            return sma;
        }

        /**
         * Calcula el Suavizamiento Exponencial Simple (SES).
         */
        function calculateExponentialSmoothing(data, alpha) {
            const ses = [data[0]]; // El primer pronóstico es el primer valor real
            for (let i = 1; i < data.length; i++) {
                const forecast = alpha * data[i - 1] + (1 - alpha) * ses[i - 1];
                ses.push(Math.round(forecast));
            }
            // Pronóstico para el siguiente periodo
            const lastForecast = alpha * data[data.length - 1] + (1-alpha) * ses[ses.length - 1];
            ses.push(Math.round(lastForecast));
            return ses;
        }


        // Event Listener para el botón de calcular
        calculateBtn.addEventListener('click', () => {
            const selectedSeries = document.getElementById('data-series').value;
            const alpha = parseFloat(alphaInput.value);
            const dataValues = historicalData[selectedSeries];

            if (!dataValues || dataValues.length < 2) {
                alert('No se encontraron datos para la serie seleccionada.');
                return;
            }
            
            // Realizar cálculos
            const smaForecast = calculateSMA(dataValues, 2); // Usamos un período de 2 años
            const sesForecast = calculateExponentialSmoothing(dataValues, alpha);
            
            // Mostrar resultados
            resultsContainer.style.display = 'block';
            renderChart(dataValues, smaForecast, sesForecast);
            renderTable(dataValues, smaForecast, sesForecast);
        });

        /**
         * Renderiza el gráfico con los datos y pronósticos.
         */
        function renderChart(actualData, smaData, sesData) {
            if (myChart) {
                myChart.destroy(); // Destruir el gráfico anterior si existe
            }
            
            const labels = [...historicalData.labels, `Pronóstico ${parseInt(historicalData.labels.slice(-1)) + 1}`];

            const ctx = chartCanvas.getContext('2d');
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Valores Reales',
                            data: [...actualData, null], // null para que no dibuje linea al pronostico
                            borderColor: '#2A1442',
                            backgroundColor: '#2A1442',
                            borderWidth: 3,
                            tension: 0.1
                        },
                        {
                            label: 'Promedio Móvil (SMA, n=2)',
                            data: smaData,
                            borderColor: '#B7955A', // Color Accent
                            backgroundColor: '#B7955A',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.1
                        },
                        {
                            label: `Suav. Exponencial (α=${alphaInput.value})`,
                            data: sesData,
                            borderColor: '#009FB7',
                            backgroundColor: '#009FB7',
                            borderWidth: 2,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Número de Estudiantes'
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: 'Año'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `Proyección de ${document.getElementById('data-series').options[document.getElementById('data-series').selectedIndex].text}`
                        }
                    }
                }
            });
        }
        
        /**
         * Renderiza la tabla de resultados.
         */
        function renderTable(actualData, smaData, sesData) {
            let tableHTML = `
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Año</th>
                            <th>Valor Real</th>
                            <th>Pronóstico SMA (n=2)</th>
                            <th>Pronóstico SES (α=${alphaInput.value})</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            const labels = [...historicalData.labels, `Pronóstico ${parseInt(historicalData.labels.slice(-1)) + 1}`];

            for(let i=0; i < labels.length; i++) {
                const actualValue = i < actualData.length ? actualData[i] : '<strong>N/A</strong>';
                const smaValue = smaData[i] !== null ? smaData[i].toFixed(2) : '-';
                const sesValue = sesData[i] !== null ? sesData[i].toFixed(2) : '-';
                
                const isForecastRow = i === labels.length - 1;
                const rowClass = isForecastRow ? 'bg-blue-50 font-bold' : '';

                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${labels[i]}</td>
                        <td>${actualValue}</td>
                        <td>${smaValue}</td>
                        <td>${sesValue}</td>
                    </tr>
                `;
            }

            tableHTML += '</tbody></table>';
            resultsTable.innerHTML = tableHTML;
        }

    </script>
</body>
</html>
