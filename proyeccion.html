<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Proyecci칩n General - M칠todos Estad칤sticos FIT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="top-bar">
    <div>
      <a href="https://fit.um.edu.mx" target="_blank">游깷 https://fit.um.edu.mx</a>
    </div>
    <div>
      <a href="#"><i class="fab fa-facebook-f"></i></a>
      <a href="#"><i class="fab fa-twitter"></i></a>
      <button class="btn-theme" onclick="toggleTheme()">游꿛 Tema</button>
    </div>
  </div>

  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="https://fit.um.edu.mx/wp-content/uploads/2021/11/color-fitec-nombre.png" alt="FIT">
      </a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="registrar.html">Registrar A침o</a></li>
          <li class="nav-item"><a class="nav-link" href="historico.html">Ver Hist칩rico</a></li>
          <li class="nav-item"><a class="nav-link active" href="proyeccion.html">Proyecci칩n General</a></li>
          <li class="nav-item"><a class="nav-link" href="grafica.html">Series de Tiempo</a></li>
          <li class="nav-item"><a class="nav-link" href="acerca.html">Acerca de</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="banner">
    <div class="container">
      <div class="hashtag">#SOYFITEC</div>
      <h1>FACULTAD DE INGENIER칈A Y TECNOLOG칈A</h1>
      <div class="hashtag">#Fitec30</div>
    </div>
  </div>

  <main class="container-main">
    <div class="content-area">
      <h4 class="mb-4">An치lisis de Regresi칩n Lineal</h4>

      <div class="form-group">
        <label for="variable-y" class="form-label">Variable Dependiente (Y):</label>
        <select id="variable-y" class="form-select"></select>
      </div>

      <div class="form-group">
        <label for="variables-x" class="form-label">Variables Independientes (X):</label>
        <select id="variables-x" class="form-select" multiple size="6">
          <!-- Se llenar치 din치micamente -->
        </select>
        <small class="text-muted">Mant칠n presionada Ctrl (o Cmd) para seleccionar m칰ltiples.</small>
      </div>

      <button id="calcular-btn" class="btn btn-main-action w-100 mb-4">Calcular Regresi칩n</button>

      <h5>Resultados:</h5>
      <pre id="resultados" class="d-none">Cargando...</pre>

      <div class="chart-container">
        <canvas id="grafico-regresion"></canvas>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>춸 <span id="currentYear"></span> Facultad de Ingenier칤a - M칠todos Estad칤sticos</p>
    </div>
  </footer>

  <script src="main.js"></script>
  <script>
    // Variables globales
    let datosCompletos = [];
    let nombresColumnas = [];
    let regressionChart = null;

    // Cargar datos al iniciar
    document.addEventListener('DOMContentLoaded', async () => {
      const selectY = document.getElementById('variable-y');
      const selectX = document.getElementById('variables-x');
      const resultadosDiv = document.getElementById('resultados');

      try {
        const response = await fetch('http://localhost:3000/api/registros');
        if (!response.ok) throw new Error(`Error ${response.status}`);
        const data = await response.json();

        if (!Array.isArray(data) || data.length === 0) {
          resultadosDiv.textContent = 'No hay datos suficientes para el an치lisis.';
          resultadosDiv.classList.remove('d-none');
          return;
        }

        // Transformar datos a formato plano por a침o y carrera
        // Creamos un mapa: A침o + Carrera -> { A침o, Carrera, Ingresos, Egresos }
        const flatData = [];
        const a침os = [...new Set(data.map(d => d.A침o))];
        const carreras = [...new Set(data.map(d => d.Carrera))];

        a침os.forEach(a침o => {
          const totalIngresos = data.filter(d => d.A침o == a침o).reduce((sum, d) => sum + (d.Ingresos || 0), 0);
          const totalEgresos = data.filter(d => d.A침o == a침o).reduce((sum, d) => sum + (d.Egresos || 0), 0);

          // Agregar fila por a침o
          flatData.push({
            A침o: parseInt(a침o),
            TOTAL_INGRESOS: totalIngresos,
            TOTAL_EGRESOS: totalEgresos
          });

          // Opcional: agregar por carrera
          carreras.forEach(carrera => {
            const registro = data.find(d => d.A침o == a침o && d.Carrera === carrera);
            if (registro) {
              const clave = carrera.replace(/\s+/g, '_').toUpperCase();
              if (!flatData[flatData.length - 1].hasOwnProperty(clave + '_INGRESOS')) {
                flatData[flatData.length - 1][clave + '_INGRESOS'] = registro.Ingresos || 0;
                flatData[flatData.length - 1][clave + '_EGRESOS'] = registro.Egresos || 0;
              }
            }
          });
        });

        datosCompletos = flatData;
        nombresColumnas = Object.keys(datosCompletos[0]);

        // Llenar selects
        nombresColumnas.forEach(nombre => {
          selectY.innerHTML += `<option value="${nombre}">${nombre}</option>`;
          selectX.innerHTML += `<option value="${nombre}">${nombre}</option>`;
        });

      } catch (error) {
        console.error('Error al cargar datos:', error);
        document.getElementById('resultados').textContent = `Error: ${error.message}`;
        document.getElementById('resultados').classList.remove('d-none');
      }
    });

    // Calcular regresi칩n
    document.getElementById('calcular-btn').addEventListener('click', async () => {
      const selectY = document.getElementById('variable-y');
      const selectX = document.getElementById('variables-x');
      const resultadosDiv = document.getElementById('resultados');

      const varY = selectY.value;
      const varsX = Array.from(selectX.selectedOptions).map(opt => opt.value);

      if (!varY || varsX.length === 0) {
        alert('Selecciona al menos una variable Y y una o m치s variables X.');
        return;
      }

      // Preparar datos
      const y_values = datosCompletos.map(fila => parseFloat(fila[varY])).filter(val => !isNaN(val));
      const x_values = datosCompletos
        .map(fila => varsX.map(nombre => parseFloat(fila[nombre])))
        .filter((_, i) => !isNaN(y_values[i]));

      // Filtrar filas con datos incompletos
      const validIndices = y_values.map((y, i) => !isNaN(y) && x_values[i].every(x => !isNaN(x)));
      const y_clean = y_values.filter((_, i) => validIndices[i]);
      const x_clean = x_values.filter((_, i) => validIndices[i]);

      if (y_clean.length === 0) {
        resultadosDiv.textContent = 'No hay datos num칠ricos v치lidos para el an치lisis.';
        resultadosDiv.classList.remove('d-none');
        return;
      }

      try {
        const response = await fetch('http://localhost:3000/api/regresion', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ x_values: x_clean, y_values: y_clean })
        });

        const resultados = await response.json();

        if (!response.ok) {
          throw new Error(resultados.error || 'Error en el c치lculo');
        }

        // Mostrar resultados
        resultadosDiv.textContent = JSON.stringify({
          ecuacion: resultados.equation,
          coeficientes: resultados.coefficients,
          r_cuadrado: resultados.rSquared
        }, null, 2);
        resultadosDiv.classList.remove('d-none');

        // Graficar solo si es regresi칩n simple
        const ctx = document.getElementById('grafico-regresion').getContext('2d');
        if (regressionChart) regressionChart.destroy();

        if (varsX.length === 1) {
          const x_data = x_clean.map(row => row[0]);
          const y_data = y_clean;
          const coef = resultados.coefficients;
          const intercepto = coef[coef.length - 1]; // 칔ltimo es B0
          const pendiente = coef[0]; // Primero es B1

          const lineaY = x_data.map(x => pendiente * x + intercepto);

          regressionChart = new Chart(ctx, {
            type: 'scatter',
            data: {
              datasets: [{
                label: 'Datos reales',
                data: x_data.map((x, i) => ({ x, y: y_data[i] })),
                backgroundColor: 'rgba(42, 20, 66, 0.7)'
              }, {
                label: 'L칤nea de regresi칩n',
                data: x_data.map((x, i) => ({ x, y: lineaY[i] })),
                type: 'line',
                borderColor: 'rgba(183, 149, 90, 1)',
                borderWidth: 2,
                fill: false,
                pointRadius: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { title: { display: true, text: varsX[0] } },
                y: { title: { display: true, text: varY } }
              }
            }
          });
        } else {
          ctx.canvas.parentNode.innerHTML = '<p class="text-center mt-3">Gr치fico disponible solo para regresi칩n simple (1 variable X).</p>';
        }

      } catch (error) {
        console.error('Error en regresi칩n:', error);
        resultadosDiv.textContent = `Error: ${error.message}`;
        resultadosDiv.classList.remove('d-none');
      }
    });
  </script>
</body>
</html>
